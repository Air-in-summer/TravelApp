<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:TravelApplication.ViewModels"
             xmlns:models="clr-namespace:TravelApplication.Models"
             x:Class="TravelApplication.Pages.MajorPage.SuggestPage"
             x:DataType="viewmodels:SuggestViewModel"
             BackgroundColor="#F5F5F5"
             Title="Optimize Itinerary">

    <ScrollView>
        <VerticalStackLayout Spacing="18" Padding="15">
            
            <!-- Loading Indicator -->
            <ActivityIndicator IsVisible="{Binding IsBusy}" 
                             IsRunning="{Binding IsBusy}" 
                             Color="#2196F3"
                             HeightRequest="50"
                             VerticalOptions="Center"/>

            <!-- Header Card -->
            <Border BackgroundColor="White" 
                    Padding="20"
                    StrokeThickness="0"
                    IsVisible="{Binding IsNotBusy}">
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.1" Radius="12" Offset="0,4"/>
                </Border.Shadow>
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>
                
                <VerticalStackLayout Spacing="12">
                    <Label Text="âœ¨ Optimize Itinerary" 
                           FontSize="28" 
                           FontAttributes="Bold"
                           TextColor="#212121"/>
                    
                    <Label Text="Select stops to optimize and let the algorithm find the best route for you"
                           FontSize="15"
                           TextColor="#616161"
                           LineBreakMode="WordWrap"/>
                </VerticalStackLayout>
            </Border>

            <!-- Budget Constraint Card -->
            <Border BackgroundColor="White" 
                    Padding="18"
                    StrokeThickness="0"
                    IsVisible="{Binding IsNotBusy}">
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.1" Radius="10" Offset="0,3"/>
                </Border.Shadow>
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="15"/>
                </Border.StrokeShape>
                
                <HorizontalStackLayout Spacing="15" VerticalOptions="Center">
                    <Border BackgroundColor="#E3F2FD" 
                            WidthRequest="50" 
                            HeightRequest="50"
                            StrokeThickness="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Label Text="ðŸ’°" 
                               FontSize="26" 
                               HorizontalOptions="Center" 
                               VerticalOptions="Center"/>
                    </Border>
                    
                    <VerticalStackLayout Spacing="5" HorizontalOptions="FillAndExpand">
                        <Label Text="Budget Constraint" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="#212121"/>
                        <Label Text="Total cost â‰¤ trip budget"
                               FontSize="14"
                               TextColor="#616161"/>
                    </VerticalStackLayout>
                    
                    <CheckBox IsChecked="{Binding UseBudgetConstraint}" 
                              Color="#2196F3"
                              Scale="1.2"
                              VerticalOptions="Center"/>
                </HorizontalStackLayout>
            </Border>

            <!-- Stops Collection -->
            <CollectionView ItemsSource="{Binding Stops}" 
                          SelectionMode="None" 
                          IsVisible="{Binding IsNotBusy}">
                <CollectionView.EmptyView>
                    <Border BackgroundColor="White" 
                            Padding="40,70"
                            StrokeThickness="0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="16"/>
                        </Border.StrokeShape>
                        <Border.Shadow>
                            <Shadow Brush="Black" Opacity="0.08" Radius="10" Offset="0,2"/>
                        </Border.Shadow>
                        <VerticalStackLayout Spacing="15" HorizontalOptions="Center">
                            <Border BackgroundColor="#E3F2FD" 
                                    WidthRequest="100" 
                                    HeightRequest="100"
                                    StrokeThickness="0">
                                <Border.StrokeShape>
                                    <Ellipse/>
                                </Border.StrokeShape>
                                <Label Text="ðŸ“" 
                                       FontSize="50" 
                                       HorizontalOptions="Center" 
                                       VerticalOptions="Center"/>
                            </Border>
                            <Label Text="No Stops Yet" 
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#212121"
                                   HorizontalOptions="Center"/>
                            <Label Text="Add stops to your trip before using this feature"
                                   FontSize="15"
                                   TextColor="#616161"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"
                                   LineBreakMode="WordWrap"/>
                        </VerticalStackLayout>
                    </Border>
                </CollectionView.EmptyView>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:SelectableStop">
                        <Border BackgroundColor="White" 
                                Padding="18" 
                                Margin="0,0,0,12"
                                StrokeThickness="0">
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.08" Radius="10" Offset="0,2"/>
                            </Border.Shadow>
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="15"/>
                            </Border.StrokeShape>
                            
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*" RowSpacing="10">
                                
                                <!-- Header Row -->
                                <VerticalStackLayout Grid.Row="0" Spacing="8">
                                    <CheckBox IsChecked="{Binding IsSelectedForSorting}" 
                                              Color="#2196F3"
                                              Scale="1.1"
                                              HorizontalOptions="Start"/>
                                    <Label Text="{Binding Stop.Location}" 
                                           FontAttributes="Bold" 
                                           FontSize="19" 
                                           TextColor="#212121"
                                           LineBreakMode="WordWrap"
                                           Margin="0,0,0,0"/>
                                </VerticalStackLayout>

                                <!-- Notes -->
                                <Label Grid.Row="1"
                                       Text="{Binding Stop.Notes}" 
                                       TextColor="#757575" 
                                       FontSize="14"
                                       Margin="0,0,0,0"
                                       LineBreakMode="WordWrap"
                                       MaxLines="2"/>

                                <!-- Date/Time Info -->
                                <Border Grid.Row="2"
                                        Padding="12,10"
                                        BackgroundColor="#FFF3E0"
                                        StrokeThickness="0"
                                        Margin="0,0,0,0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10"/>
                                    </Border.StrokeShape>
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="ðŸ—“ï¸:" 
                                               FontSize="15" 
                                               FontAttributes="Bold"
                                               TextColor="#F57C00"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding Stop.ArrivalDate, StringFormat='{0:dd/MM HH:mm}'}" 
                                               FontSize="13"
                                               FontAttributes="Bold"
                                               TextColor="#F57C00"
                                               VerticalOptions="Center"/>
                                        <Label Text="â†’" 
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="#F57C00"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding Stop.DepartureDate, StringFormat='{0:dd/MM HH:mm}'}" 
                                               FontSize="13"
                                               FontAttributes="Bold"
                                               TextColor="#F57C00"
                                               VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                </Border>

                                <!-- Cost Badge -->
                                <Border Grid.Row="3"
                                        Padding="12,8"
                                        BackgroundColor="#E8F5E9"
                                        StrokeThickness="0"
                                        HorizontalOptions="Start"
                                        Margin="0,0,0,0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12"/>
                                    </Border.StrokeShape>
                                    <Label Text="{Binding Stop.EstimatedCost, StringFormat='ðŸ’° {0:N0} Ä‘'}" 
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="#2E7D32"/>
                                </Border>

                                <!-- Category (Hidden - Debug only) -->
                                <!-- Uncomment to show: -->
                                <!--
                                <Label Grid.Row="3" Grid.Column="1" 
                                       Text="{Binding Stop.Category}" 
                                       TextColor="#9E9E9E" 
                                       FontSize="11" 
                                       HorizontalOptions="End"
                                       VerticalOptions="End"/>
                                -->
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Suggest Button -->
            <Border BackgroundColor="#2196F3" 
                    Padding="0"
                    StrokeThickness="0"
                    Margin="0,10,0,0"
                    IsVisible="{Binding IsNotBusy}">
                <Border.Shadow>
                    <Shadow Brush="#2196F3" Opacity="0.3" Radius="12" Offset="0,4"/>
                </Border.Shadow>
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>
                <Button Text="âœ¨ Optimize Route" 
                        Clicked="OnSuggestClicked"
                        TextColor="White" 
                        BackgroundColor="Transparent"
                        FontSize="17"
                        FontAttributes="Bold"
                        HeightRequest="56"
                        IsEnabled="{Binding IsNotBusy}"/>
            </Border>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
